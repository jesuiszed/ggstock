{% extends "base.html" %}

{% block title %}Détails de l'appareil - {{ appareil.produit.nom }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- En-tête -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Détails de l'appareil</h1>
        <div class="flex space-x-2">
            <a href="{% url 'inventory:appareil_list' %}" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-arrow-left mr-2"></i>Retour à la liste
            </a>
            {% if user.profile.role in 'MANAGER,TECHNICIEN' %}
            <a href="{% url 'inventory:appareil_list' %}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-list mr-2"></i>Liste des appareils
            </a>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Informations principales -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Informations de base -->
            <div class="bg-white shadow-md rounded-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    Informations générales
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Produit</label>
                        <p class="text-lg font-semibold text-gray-900">{{ appareil.produit.nom }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Numéro de série</label>
                        <p class="text-lg font-semibold text-gray-900">{{ appareil.numero_serie }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Client</label>
                        <p class="text-lg font-semibold text-gray-900">
                            <a href="{% url 'inventory:client_detail' appareil.client.pk %}" class="text-blue-600 hover:text-blue-800">
                                {{ appareil.client.nom_complet }}
                            </a>
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Date de vente</label>
                        <p class="text-lg font-semibold text-gray-900">{{ appareil.date_vente|date:"d/m/Y" }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Prix de vente</label>
                        <p class="text-lg font-semibold text-green-600">{{ appareil.prix_vente|floatformat:2 }} F CFA</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Statut</label>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                            {% if appareil.statut == 'OPERATIONNEL' %}bg-green-100 text-green-800
                            {% elif appareil.statut == 'EN_MAINTENANCE' %}bg-yellow-100 text-yellow-800
                            {% elif appareil.statut == 'HORS_SERVICE' %}bg-red-100 text-red-800
                            {% elif appareil.statut == 'EN_REPARATION' %}bg-blue-100 text-blue-800
                            {% elif appareil.statut == 'RETIRE' %}bg-gray-100 text-gray-800
                            {% endif %}">
                            {{ appareil.get_statut_display }}
                        </span>
                    </div>
                </div>
                
                {% if appareil.configuration %}
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-500">Configuration</label>
                    <p class="text-gray-900 mt-1">{{ appareil.configuration }}</p>
                </div>
                {% endif %}
                
                {% if appareil.localisation %}
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-500">Localisation</label>
                    <p class="text-gray-900 mt-1">{{ appareil.localisation }}</p>
                </div>
                {% endif %}
                
                {% if appareil.observations %}
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-500">Observations</label>
                    <p class="text-gray-900 mt-1">{{ appareil.observations }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Garantie et maintenance -->
            <div class="bg-white shadow-md rounded-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    Garantie et maintenance
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% if appareil.date_fin_garantie %}
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Fin de garantie</label>
                        <p class="text-lg font-semibold {% if appareil.date_fin_garantie < today %}text-red-600{% else %}text-gray-900{% endif %}">
                            {{ appareil.date_fin_garantie|date:"d/m/Y" }}
                            {% if appareil.date_fin_garantie < today %}
                                <span class="text-sm text-red-500">(Expirée)</span>
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if appareil.derniere_maintenance %}
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Dernière maintenance</label>
                        <p class="text-lg font-semibold text-gray-900">{{ appareil.derniere_maintenance|date:"d/m/Y" }}</p>
                    </div>
                    {% endif %}
                    
                    {% if appareil.prochaine_maintenance %}
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Prochaine maintenance</label>
                        <p class="text-lg font-semibold {% if appareil.prochaine_maintenance < today %}text-red-600{% else %}text-gray-900{% endif %}">
                            {{ appareil.prochaine_maintenance|date:"d/m/Y" }}
                            {% if appareil.prochaine_maintenance < today %}
                                <span class="text-sm text-red-500">(En retard)</span>
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if appareil.contrat_maintenance %}
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Contrat de maintenance</label>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Actif
                        </span>
                    </div>
                    {% endif %}
                </div>
                
                {% if appareil.contact_maintenance %}
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-500">Contact maintenance</label>
                    <p class="text-gray-900 mt-1">{{ appareil.contact_maintenance }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Historique des interventions -->
            <div class="bg-white shadow-md rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2">
                        Historique des interventions
                    </h2>
                    <a href="{% url 'inventory:intervention_create' %}?appareil={{ appareil.pk }}" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">
                        <i class="fas fa-plus mr-2"></i>Nouvelle intervention
                    </a>
                </div>
                
                {% if interventions %}
                <div class="space-y-3">
                    {% for intervention in interventions %}
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-gray-900">{{ intervention.numero_intervention }}</div>
                                <div class="text-sm text-gray-600">{{ intervention.get_type_intervention_display }}</div>
                                <div class="text-sm text-gray-500">{{ intervention.date_prevue|date:"d/m/Y H:i" }}</div>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if intervention.statut == 'PLANIFIEE' %}bg-blue-100 text-blue-800
                                    {% elif intervention.statut == 'EN_COURS' %}bg-yellow-100 text-yellow-800
                                    {% elif intervention.statut == 'TERMINEE' %}bg-green-100 text-green-800
                                    {% elif intervention.statut == 'REPORTEE' %}bg-orange-100 text-orange-800
                                    {% elif intervention.statut == 'ANNULEE' %}bg-red-100 text-red-800
                                    {% endif %}">
                                    {{ intervention.get_statut_display }}
                                </span>
                                <div class="text-sm text-gray-500 mt-1">{{ intervention.technicien.get_full_name }}</div>
                            </div>
                        </div>
                        {% if intervention.description %}
                        <div class="mt-2 text-sm text-gray-600">{{ intervention.description|truncatewords:20 }}</div>
                        {% endif %}
                        <div class="mt-2">
                            <a href="{% url 'inventory:intervention_detail' intervention.pk %}" class="text-blue-600 hover:text-blue-800 text-sm">
                                Voir les détails →
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">Aucune intervention enregistrée pour cet appareil.</p>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Actions rapides -->
            <div class="bg-white shadow-md rounded-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Actions rapides</h3>
                <div class="space-y-2">
                    <a href="{% url 'inventory:intervention_create' %}?appareil={{ appareil.pk }}" class="w-full bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded block text-center">
                        <i class="fas fa-tools mr-2"></i>Planifier intervention
                    </a>
                    {% if user.profile.role in 'MANAGER,TECHNICIEN' %}
                    <a href="{% url 'inventory:appareil_list' %}" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded block text-center">
                        <i class="fas fa-list mr-2"></i>Liste des appareils
                    </a>
                    {% endif %}
                    <a href="{% url 'inventory:client_detail' appareil.client.pk %}" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded block text-center">
                        <i class="fas fa-user mr-2"></i>Voir le client
                    </a>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="bg-white shadow-md rounded-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Statistiques</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Interventions totales</span>
                        <span class="font-semibold text-gray-900">{{ interventions|length }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Interventions terminées</span>
                        <span class="font-semibold text-green-600">{{ interventions_terminees }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Interventions en cours</span>
                        <span class="font-semibold text-yellow-600">{{ interventions_en_cours }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Âge de l'appareil</span>
                        <span class="font-semibold text-gray-900">{{ age_appareil }} jours</span>
                    </div>
                </div>
            </div>

            <!-- Alertes -->
            <div class="bg-white shadow-md rounded-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Alertes</h3>
                <div class="space-y-2">
                    {% if appareil.date_fin_garantie and appareil.date_fin_garantie < today %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span class="text-sm">Garantie expirée</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if appareil.prochaine_maintenance and appareil.prochaine_maintenance < today %}
                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                        <div class="flex items-center">
                            <i class="fas fa-wrench mr-2"></i>
                            <span class="text-sm">Maintenance en retard</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if appareil.statut == 'HORS_SERVICE' %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <div class="flex items-center">
                            <i class="fas fa-times-circle mr-2"></i>
                            <span class="text-sm">Hors service</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if not appareil.date_fin_garantie and not appareil.prochaine_maintenance and appareil.statut == 'OPERATIONNEL' %}
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span class="text-sm">Aucune alerte</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
