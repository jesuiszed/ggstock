{% extends 'base.html' %}

{% block title %}Nouvelle Vente Complète{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- En-tête -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-cash-register text-green-600 mr-3"></i>
                Nouvelle Vente Complète
            </h1>
            <div class="flex space-x-3">
                <a href="{% url 'inventory:ventes_list' %}" 
                   class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Retour à la liste
                </a>
                <button type="button" id="saveAsDraft" 
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-save mr-2"></i>Sauvegarder brouillon
                </button>
            </div>
        </div>

        <form method="post" id="venteForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Informations de la vente -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    Informations générales
                </h2>
                
                {% if form.errors %}
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700 font-medium">Erreurs détectées :</p>
                                <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ field }} : {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="{{ form.numero_vente.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-hashtag mr-1"></i>{{ form.numero_vente.label }}
                        </label>
                        {{ form.numero_vente }}
                        <p class="text-xs text-gray-500 mt-1">Numéro généré automatiquement</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.client.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>{{ form.client.label }}
                        </label>
                        {{ form.client }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.client.help_text }}</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.mode_paiement.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-credit-card mr-1"></i>{{ form.mode_paiement.label }}
                        </label>
                        {{ form.mode_paiement }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.mode_paiement.help_text }}</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.remise.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-percent mr-1"></i>{{ form.remise.label }}
                        </label>
                        {{ form.remise }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.remise.help_text }}</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="{{ form.notes.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sticky-note mr-1"></i>{{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                    </div>
                </div>
            </div>

            <!-- Produits de la vente -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-shopping-cart text-green-500 mr-2"></i>
                        Produits à vendre
                    </h2>
                    <button type="button" id="addProduct" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                        <i class="fas fa-plus mr-2"></i>Ajouter un produit
                    </button>
                </div>

                <div id="productsContainer" class="space-y-4">
                    <!-- Les lignes de produits seront ajoutées ici dynamiquement -->
                </div>

                <!-- Résumé financier -->
                <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium">Sous-total :</span>
                            <span id="subtotal" class="font-bold">0,00 F CFA</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Remise :</span>
                            <span id="discountAmount" class="font-bold text-red-600">0,00 F CFA</span>
                        </div>
                        <div class="flex justify-between border-t pt-2 md:border-t-0 md:pt-0">
                            <span class="font-bold text-lg">Total :</span>
                            <span id="total" class="font-bold text-lg text-green-600">0,00 F CFA</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Vérifiez tous les détails avant de finaliser la vente
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <a href="{% url 'inventory:ventes_list' %}" 
                           class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition duration-200 text-center">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </a>
                        <button type="submit" name="action" value="save_and_continue"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-save mr-2"></i>Enregistrer et continuer
                        </button>
                        <button type="submit" name="action" value="finalize"
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-check mr-2"></i>Finaliser la vente
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Template pour une ligne de produit -->
<template id="productTemplate">
    <div class="product-line bg-gray-50 border border-gray-200 rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-medium text-gray-700">
                <i class="fas fa-box mr-1"></i>Ligne produit
            </h4>
            <button type="button" class="remove-product text-red-600 hover:text-red-800 p-1 rounded">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">Produit</label>
                <select name="produit" class="product-select w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                    <option value="">Sélectionnez un produit...</option>
                    {% for produit in produits %}
                    <option value="{{ produit.id }}" 
                            data-price="{{ produit.prix_vente }}" 
                            data-stock="{{ produit.quantite_stock }}"
                            data-name="{{ produit.nom }}">
                        {{ produit.nom }} ({{ produit.reference }}) - Stock: {{ produit.quantite_stock }} - {{ produit.prix_vente }}F CFA
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Quantité</label>
                <input type="number" name="quantite" min="1" value="1" 
                       class="quantity-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                <div class="text-xs text-gray-500 mt-1">Stock: <span class="stock-info">-</span></div>
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Prix unitaire (F CFA)</label>
                <input type="number" name="prix_unitaire" step="0.01" min="0.01" 
                       class="price-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                <div class="text-xs font-medium text-green-600 mt-1">Sous-total: <span class="line-subtotal">0,00 F CFA</span></div>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lineCount = 0;
    
    // Ajouter une ligne de produit au chargement
    addProductLine();
    
    // Ajouter une ligne de produit
    document.getElementById('addProduct').addEventListener('click', function() {
        addProductLine();
    });
    
    function addProductLine() {
        const template = document.getElementById('productTemplate');
        const clone = template.content.cloneNode(true);
        
        // Mettre à jour les noms des champs avec le bon format
        const inputs = clone.querySelectorAll('input, select');
        inputs.forEach(input => {
            const originalName = input.getAttribute('name');
            input.name = `ligne_${lineCount}_${originalName}`;
            console.log('Setting field name:', input.name); // Debug
        });
        
        document.getElementById('productsContainer').appendChild(clone);
        
        // Ajouter les event listeners
        const newLine = document.getElementById('productsContainer').lastElementChild;
        setupLineEvents(newLine, lineCount);
        
        lineCount++;
        updateTotal();
    }
    
    // Configuration des événements pour une ligne
    function setupLineEvents(line, index) {
        const productSelect = line.querySelector('.product-select');
        const quantityInput = line.querySelector('.quantity-input');
        const priceInput = line.querySelector('.price-input');
        const stockInfo = line.querySelector('.stock-info');
        const subtotalSpan = line.querySelector('.line-subtotal');
        const removeBtn = line.querySelector('.remove-product');
        
        // Sélection de produit
        productSelect.addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            if (option.value) {
                const price = parseFloat(option.dataset.price);
                const stock = parseInt(option.dataset.stock);
                const name = option.dataset.name;
                
                priceInput.value = price.toFixed(2);
                stockInfo.textContent = stock;
                quantityInput.max = stock;
                
                // Calculer le sous-total
                updateLineSubtotal();
                updateTotal();
            } else {
                priceInput.value = '';
                stockInfo.textContent = '-';
                quantityInput.max = '';
                subtotalSpan.textContent = '0,00 F CFA';
            }
        });
        
        // Modification de la quantité
        quantityInput.addEventListener('input', function() {
            const max = parseInt(this.max);
            const value = parseInt(this.value);
            
            if (value > max && max > 0) {
                this.value = max;
                alert(`Stock insuffisant! Maximum disponible: ${max}`);
            }
            
            updateLineSubtotal();
            updateTotal();
        });
        
        // Modification du prix
        priceInput.addEventListener('input', function() {
            updateLineSubtotal();
            updateTotal();
        });
        
        // Supprimer la ligne
        removeBtn.addEventListener('click', function() {
            if (document.querySelectorAll('.product-line').length > 1) {
                line.remove();
                updateTotal();
            } else {
                alert('Vous devez avoir au moins une ligne de produit!');
            }
        });
        
        function updateLineSubtotal() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const subtotal = quantity * price;
            subtotalSpan.textContent = subtotal.toFixed(2) + ' F CFA';
        }
    }
                const stock = parseInt(option.dataset.stock);
                
                priceInput.value = price.toFixed(2);
                stockInfo.textContent = stock;
                quantityInput.max = stock;
                
                // Ajuster la quantité si elle dépasse le stock
                if (parseInt(quantityInput.value) > stock) {
                    quantityInput.value = Math.min(stock, 1);
                }
            } else {
                priceInput.value = '';
                stockInfo.textContent = '-';
                quantityInput.max = '';
            }
            updateLineSubtotal(line);
        });
        
        // Changement de quantité ou prix
        quantityInput.addEventListener('input', () => updateLineSubtotal(line));
        priceInput.addEventListener('input', () => updateLineSubtotal(line));
        
        // Supprimer la ligne
        removeBtn.addEventListener('click', function() {
            line.remove();
            updateTotal();
        });
    }
    
    // Mettre à jour le sous-total d'une ligne
    function updateLineSubtotal(line) {
        const quantity = parseFloat(line.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(line.querySelector('.price-input').value) || 0;
        const subtotal = quantity * price;
        
        line.querySelector('.line-subtotal').textContent = subtotal.toFixed(2) + ' F CFA';
        updateTotal();
    }
    
    // Mettre à jour le total général
    function updateTotal() {
        let subtotal = 0;
        
        document.querySelectorAll('.product-line').forEach(line => {
            const quantity = parseFloat(line.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(line.querySelector('.price-input').value) || 0;
            subtotal += quantity * price;
        });
        
        const remisePercent = parseFloat(document.getElementById('{{ form.remise.id_for_label }}').value) || 0;
        const remiseAmount = subtotal * remisePercent / 100;
        const total = subtotal - remiseAmount;
        
        document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' F CFA';
        document.getElementById('discountAmount').textContent = remiseAmount.toFixed(2) + ' F CFA';
        document.getElementById('total').textContent = total.toFixed(2) + ' F CFA';
    }
    
    // Mettre à jour le total quand la remise change
    document.getElementById('{{ form.remise.id_for_label }}').addEventListener('input', updateTotal);
    
    // Ajouter une première ligne par défaut
    document.getElementById('addProduct').click();
    
    // Validation avant soumission
    document.getElementById('venteForm').addEventListener('submit', function(e) {
        const lines = document.querySelectorAll('.product-line');
        if (lines.length === 0) {
            e.preventDefault();
            alert('Veuillez ajouter au moins un produit à la vente.');
            return;
        }
        
        let hasValidLine = false;
        lines.forEach(line => {
            const productSelect = line.querySelector('.product-select');
            const quantity = line.querySelector('.quantity-input').value;
            
            if (productSelect.value && quantity > 0) {
                hasValidLine = true;
            }
        });
        
        if (!hasValidLine) {
            e.preventDefault();
            alert('Veuillez sélectionner au moins un produit avec une quantité valide.');
        }
    });
});
</script>

<style>
.product-line {
    transition: all 0.3s ease;
}

.product-line:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.remove-product:hover {
    background-color: rgba(248, 113, 113, 0.1);
}
</style>
{% endblock %}
