{% extends 'base.html' %}

{% block title %}Nouvelle Commande Complète{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- En-tête -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-shopping-cart text-blue-600 mr-3"></i>
                Nouvelle Commande Complète
            </h1>
            <div class="flex space-x-3">
                <a href="{% url 'inventory:commandes_list' %}" 
                   class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Retour à la liste
                </a>
                <button type="button" id="saveAsDraft" 
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-save mr-2"></i>Sauvegarder brouillon
                </button>
            </div>
        </div>

        <form method="post" id="commandeForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Informations de la commande -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    Informations générales
                </h2>
                
                {% if form.errors %}
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700 font-medium">Erreurs détectées :</p>
                                <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ field }} : {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="{{ form.numero_commande.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-hashtag mr-1"></i>{{ form.numero_commande.label }}
                        </label>
                        {{ form.numero_commande }}
                        <p class="text-xs text-gray-500 mt-1">Numéro généré automatiquement</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.client.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>{{ form.client.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.client }}
                        <div class="flex mt-2">
                            <button type="button" id="fillClientAddress" 
                                    class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition duration-200">
                                <i class="fas fa-map-marker-alt mr-1"></i>Utiliser l'adresse client
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label for="{{ form.statut.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-flag mr-1"></i>{{ form.statut.label }}
                        </label>
                        {{ form.statut }}
                        <p class="text-xs text-gray-500 mt-1">Statut actuel de la commande</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.date_livraison_prevue.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-1"></i>{{ form.date_livraison_prevue.label }}
                        </label>
                        {{ form.date_livraison_prevue }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.date_livraison_prevue.help_text }}</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="{{ form.adresse_livraison.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-1"></i>{{ form.adresse_livraison.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.adresse_livraison }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.adresse_livraison.help_text }}</p>
                    </div>
                    
                    <div class="lg:col-span-3">
                        <label for="{{ form.notes.id_for_label }}" 
                               class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sticky-note mr-1"></i>{{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                    </div>
                </div>
            </div>

            <!-- Produits de la commande -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-box text-blue-500 mr-2"></i>
                        Produits de la commande
                    </h2>
                    <button type="button" id="addProduct" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                        <i class="fas fa-plus mr-2"></i>Ajouter un produit
                    </button>
                </div>

                <div id="productsContainer" class="space-y-4">
                    <!-- Les lignes de produits seront ajoutées ici dynamiquement -->
                </div>

                <!-- Résumé financier -->
                <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Sous-total HT:</span>
                            <span id="subtotal" class="font-medium text-gray-900">0,00 F CFA</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Remise totale:</span>
                            <span id="discountAmount" class="font-medium text-red-600">0,00 F CFA</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">TVA (18%):</span>
                            <span id="tvaAmount" class="font-medium text-gray-900">0,00 F CFA</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-700 font-semibold">TOTAL TTC:</span>
                            <span id="total" class="font-bold text-blue-600 text-lg">0,00 F CFA</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 mt-2">
                        <span id="totalLines" class="font-medium">0</span> ligne(s) •
                        <span id="totalItems" class="font-medium">0</span> article(s)
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Vérifiez tous les détails avant de créer la commande
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <a href="{% url 'inventory:commandes_list' %}" 
                           class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition duration-200 text-center">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </a>
                        <button type="submit" name="action" value="save_draft"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-save mr-2"></i>Sauvegarder brouillon
                        </button>
                        <button type="submit" name="action" value="confirm"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-check mr-2"></i>Créer la commande
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Template pour une ligne de produit -->
<template id="productTemplate">
    <div class="product-line bg-gray-50 border border-gray-200 rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-medium text-gray-700">
                <i class="fas fa-box mr-1"></i>Ligne produit #<span class="line-number"></span>
            </h4>
            <button type="button" class="remove-product text-red-600 hover:text-red-800 p-1 rounded">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-5">
                <label class="block text-xs font-medium text-gray-600 mb-1">Produit <span class="text-red-500">*</span></label>
                <select name="produit" class="product-select w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                    <option value="">Sélectionnez un produit...</option>
                    {% for produit in produits %}
                    <option value="{{ produit.id }}" 
                            data-price="{{ produit.prix_vente }}" 
                            data-stock="{{ produit.quantite_stock }}"
                            data-name="{{ produit.nom }}">
                        {{ produit.nom }} ({{ produit.reference }}) - Stock: {{ produit.quantite_stock }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">Quantité <span class="text-red-500">*</span></label>
                <input type="number" name="quantite" min="1" value="1" 
                       class="quantity-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                <div class="text-xs text-gray-500 mt-1">Stock: <span class="stock-info">-</span></div>
            </div>
            
            <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">Prix unit. (F CFA) <span class="text-red-500">*</span></label>
                <input type="number" name="prix_unitaire" step="0.01" min="0.01" 
                       class="price-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            
            <div class="md:col-span-1">
                <label class="block text-xs font-medium text-gray-600 mb-1">Remise (%)</label>
                <input type="number" name="remise" step="0.01" min="0" max="100" value="0" 
                       class="remise-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            
            <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">Sous-total</label>
                <div class="text-lg font-bold text-blue-600 mt-2">
                    <span class="line-subtotal">0,00 F CFA</span>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lineCount = 0;
    
    // Données clients pour auto-complétion adresse
    const clientsData = {
        {% for client in clients %}
        {{ client.id }}: {
            'nom': '{{ client.nom_complet|escapejs }}',
            'adresse': '{{ client.adresse|escapejs }}\n{{ client.code_postal }} {{ client.ville }}\n{{ client.pays }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
    
    // Charger les lignes existantes si on est en mode édition
    {% if lignes_existantes %}
        console.log('Mode édition: chargement des lignes existantes');
        {% for ligne in lignes_existantes %}
            addProductLine({
                produit: {{ ligne.produit.id }},
                quantite: {{ ligne.quantite }},
                prix_unitaire: {{ ligne.prix_unitaire }}
            });
        {% endfor %}
    {% else %}
        // Ajouter une première ligne par défaut pour la création
        addProductLine();
    {% endif %}
    
    // Ajouter une ligne de produit
    document.getElementById('addProduct').addEventListener('click', function() {
        addProductLine();
    });
    
    function addProductLine(data = null) {
        const template = document.getElementById('productTemplate');
        const clone = template.content.cloneNode(true);
        
        // Mettre à jour les noms des champs
        const inputs = clone.querySelectorAll('input, select');
        inputs.forEach(input => {
            const name = input.name;
            input.name = `ligne_${lineCount}_${name}`;
        });
        
        // Mettre à jour le numéro de ligne
        clone.querySelector('.line-number').textContent = lineCount + 1;
        
        document.getElementById('productsContainer').appendChild(clone);
        
        // Ajouter les event listeners
        const newLine = document.getElementById('productsContainer').lastElementChild;
        setupLineEvents(newLine);
        
        // Pré-remplir si des données sont fournies
        if (data) {
            const productSelect = newLine.querySelector('.product-select');
            const quantityInput = newLine.querySelector('.quantity-input');
            const priceInput = newLine.querySelector('.price-input');
            const remiseInput = newLine.querySelector('.remise-input');
            
            productSelect.value = data.produit;
            quantityInput.value = data.quantite;
            priceInput.value = data.prix_unitaire;
            if (data.remise !== undefined) {
                remiseInput.value = data.remise;
            }
            
            // Déclencher l'événement change pour mettre à jour le stock et le sous-total
            productSelect.dispatchEvent(new Event('change'));
        }
        
        lineCount++;
        updateTotals();
    }
    
    // Configuration des événements pour une ligne
    function setupLineEvents(line) {
        const productSelect = line.querySelector('.product-select');
        const quantityInput = line.querySelector('.quantity-input');
        const priceInput = line.querySelector('.price-input');
        const remiseInput = line.querySelector('.remise-input');
        const stockInfo = line.querySelector('.stock-info');
        const subtotalSpan = line.querySelector('.line-subtotal');
        const removeBtn = line.querySelector('.remove-product');
        
        // Sélection de produit
        productSelect.addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            if (option.value) {
                const price = parseFloat(option.dataset.price);
                const stock = parseInt(option.dataset.stock);
                
                priceInput.value = price.toFixed(2);
                stockInfo.textContent = stock;
                
                // Calculer le sous-total
                updateLineSubtotal();
            } else {
                priceInput.value = '';
                stockInfo.textContent = '-';
                subtotalSpan.textContent = '0,00 F CFA';
            }
            updateTotals();
        });
        
        // Modification de la quantité
        quantityInput.addEventListener('input', function() {
            updateLineSubtotal();
            updateTotals();
        });
        
        // Modification du prix
        priceInput.addEventListener('input', function() {
            updateLineSubtotal();
            updateTotals();
        });
        
        // Modification de la remise ligne
        remiseInput.addEventListener('input', function() {
            updateLineSubtotal();
            updateTotals();
        });
        
        // Supprimer la ligne
        removeBtn.addEventListener('click', function() {
            if (document.querySelectorAll('.product-line').length > 1) {
                line.remove();
                updateLineNumbers();
                updateTotals();
            } else {
                alert('Vous devez avoir au moins une ligne de produit!');
            }
        });
        
        function updateLineSubtotal() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const remise = parseFloat(remiseInput.value) || 0;
            
            const total = quantity * price;
            const montantRemise = total * (remise / 100);
            const subtotal = total - montantRemise;
            
            subtotalSpan.textContent = subtotal.toFixed(2) + ' F CFA';
        }
    }
    
    // Mettre à jour les numéros de ligne
    function updateLineNumbers() {
        const lines = document.querySelectorAll('.product-line');
        lines.forEach((line, index) => {
            line.querySelector('.line-number').textContent = index + 1;
        });
    }
    
    // Mettre à jour les totaux généraux
    function updateTotals() {
        let subtotalHT = 0;
        let totalRemiseLignes = 0;
        let totalQuantity = 0;
        const lines = document.querySelectorAll('.product-line');
        
        lines.forEach(line => {
            const quantity = parseFloat(line.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(line.querySelector('.price-input').value) || 0;
            const remiseLigne = parseFloat(line.querySelector('.remise-input').value) || 0;
            
            const total = quantity * price;
            const montantRemiseLigne = total * (remiseLigne / 100);
            
            subtotalHT += total;
            totalRemiseLignes += montantRemiseLigne;
            totalQuantity += quantity;
        });
        
        // Calcul TVA et TTC
        const totalHT = subtotalHT - totalRemiseLignes;
        const tva = totalHT * 0.18; // TVA 18%
        const totalTTC = totalHT + tva;
        
        // Mise à jour de l'affichage
        document.getElementById('subtotal').textContent = subtotalHT.toFixed(2) + ' F CFA';
        document.getElementById('discountAmount').textContent = totalRemiseLignes.toFixed(2) + ' F CFA';
        document.getElementById('tvaAmount').textContent = tva.toFixed(2) + ' F CFA';
        document.getElementById('total').textContent = totalTTC.toFixed(2) + ' F CFA';
        document.getElementById('totalLines').textContent = lines.length;
        document.getElementById('totalItems').textContent = totalQuantity;
    }
    
    // Remplir l'adresse client automatiquement
    document.getElementById('fillClientAddress').addEventListener('click', function() {
        const clientSelect = document.getElementById('{{ form.client.id_for_label }}');
        const adresseField = document.getElementById('{{ form.adresse_livraison.id_for_label }}');
        
        if (clientSelect.value && clientsData[clientSelect.value]) {
            adresseField.value = clientsData[clientSelect.value].adresse;
        }
    });
    
    // Auto-remplir l'adresse quand le client change
    document.getElementById('{{ form.client.id_for_label }}').addEventListener('change', function() {
        const adresseField = document.getElementById('{{ form.adresse_livraison.id_for_label }}');
        
        if (this.value && clientsData[this.value] && !adresseField.value.trim()) {
            adresseField.value = clientsData[this.value].adresse;
        }
    });
    
    // Validation avant soumission
    document.getElementById('commandeForm').addEventListener('submit', function(e) {
        const lines = document.querySelectorAll('.product-line');
        if (lines.length === 0) {
            e.preventDefault();
            alert('Veuillez ajouter au moins un produit à la commande.');
            return;
        }
        
        let hasValidLine = false;
        lines.forEach(line => {
            const productSelect = line.querySelector('.product-select');
            const quantity = line.querySelector('.quantity-input').value;
            
            if (productSelect.value && quantity > 0) {
                hasValidLine = true;
            }
        });
        
        if (!hasValidLine) {
            e.preventDefault();
            alert('Veuillez sélectionner au moins un produit avec une quantité valide.');
        }
        
        // Vérification de l'adresse de livraison
        const adresseField = document.getElementById('{{ form.adresse_livraison.id_for_label }}');
        if (!adresseField.value.trim()) {
            e.preventDefault();
            alert('Veuillez renseigner l\'adresse de livraison.');
            adresseField.focus();
        }
    });
});
</script>

<style>
.product-line {
    transition: all 0.3s ease;
}

.product-line:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.remove-product:hover {
    background-color: rgba(248, 113, 113, 0.1);
}

#fillClientAddress:hover {
    transform: translateY(-1px);
}
</style>
{% endblock %}
